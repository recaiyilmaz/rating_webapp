<!DOCTYPE html>
<html>
<head>
    <title>Rate Video</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f4f4f4;
            text-align: center;
            padding: 40px;
        }

        h2 {
            margin-bottom: 20px;
        }

        video {
            border-radius: 8px;
            border: 2px solid #333;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .controls, .ratings, .info-bar, .category-ratings {
            margin-top: 20px;
        }

        button {
            padding: 8px 14px;
            margin: 6px 4px;
            font-size: 14px;
            border-radius: 6px;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: background 0.3s ease;
            cursor: pointer;
        }

        .controls button {
            background-color: #f0f0f0;
        }

        .controls button:hover {
            background-color: #e0e0e0;
        }

        .ratings button {
            background-color: #d3e0ea;
        }

        .ratings button:hover {
            background-color: #a3c4dc;
        }

        .ratings button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .info-bar {
            font-size: 18px;
            font-weight: bold;
        }

        .info-bar span {
            color: #007bff;
        }
    </style>
</head>
<body>

    <h2>Surgical Video Rating</h2>

    <video id="videoPlayer" width="960" height="540" oncontextmenu="return false;" style="pointer-events: none;">
        <source src="{{ url_for('static', filename=video_file) }}" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <div class="info-bar">
        Rating Interval: <span id="intervalDisplay">0 - 15</span> seconds |
        Time Left: <span id="countdown">...</span> seconds
    </div>

    <!-- Playback Controls -->
    <div class="controls">
        <button onclick="manualPlay()">‚ñ∂Ô∏è Play</button>
        <button onclick="video.pause()">‚è∏Ô∏è Pause</button>
        <button onclick="replaySegment()">üîÑ Replay Last 15s</button>
        <button onclick="video.playbackRate = 1">‚ñ∂Ô∏è 1x</button>
        <button onclick="video.playbackRate = 2">‚è© 2x</button>
        <button onclick="video.playbackRate = 4">‚è©‚è© 4x</button>
    </div>

    <!-- Rating Buttons -->
    <div class="ratings">
        <form method="POST" action="/submit_rating" id="ratingForm">
            <button name="rating" value="Excellent" disabled>Excellent</button>
            <button name="rating" value="Very Good" disabled>Very Good</button>
            <button name="rating" value="Good" disabled>Good</button>
            <button name="rating" value="Average" disabled>Average</button>
            <button name="rating" value="Below Average" disabled>Below Average</button>
            <button name="rating" value="Poor" disabled>Poor</button>
            <button name="rating" value="Very Poor" disabled>Very Poor</button>
            <input type="hidden" name="time" id="ratingTime">
            <input type="hidden" name="timestamp" id="timestamp">
            <input type="hidden" name="button_label" id="buttonLabel">
        </form>
    </div>

<script>
    const video = document.getElementById("videoPlayer");
    const ratingButtons = document.querySelectorAll(".ratings button");
    const ratingForm = document.getElementById("ratingForm");
    const ratingTimeInput = document.getElementById("ratingTime");
    const intervalDisplay = document.getElementById("intervalDisplay");
    const countdownTimer = document.getElementById("countdown");

    // Define all rating time points (in seconds)
    const ratingTimes = [15, 30, 45, 60, 75, 90, 105, 120];
    let currentRatingIndex = 0;
    let autoMode = true;
    let lastRealTime = 0; // Track real time accounting for speed changes

    // Initialize when video is ready
    video.addEventListener('loadedmetadata', initialize);

    function initialize() {
        updateIntervalDisplay();
        playToNextRatingPoint();
    }

    video.addEventListener("timeupdate", () => {
        // Calculate real time elapsed accounting for playback speed
        const now = Date.now();
        const delta = (now - lastRealTime) / 1000; // seconds
        lastRealTime = now;
        
        const realTimeElapsed = delta * video.playbackRate;
        const expectedVideoTime = video.currentTime + realTimeElapsed;

        // Update countdown timer
        const timeLeft = Math.max(0, Math.ceil(video.duration - expectedVideoTime));
        countdownTimer.textContent = timeLeft;

        // Check if we've reached the next rating point
        if (autoMode && currentRatingIndex < ratingTimes.length) {
            const targetTime = ratingTimes[currentRatingIndex];
            
            // Check if we've reached or passed the target time
            if (expectedVideoTime >= targetTime) {
                // Pause exactly at the rating time
                video.pause();
                video.currentTime = targetTime;
                enableRatings();
            }
        }
    });

    function playToNextRatingPoint() {
        if (currentRatingIndex >= ratingTimes.length) {
            console.log("All rating points completed");
            return;
        }

        autoMode = true;
        disableRatings();
        lastRealTime = Date.now(); // Reset real time tracking
        video.currentTime = currentRatingIndex > 0 ? ratingTimes[currentRatingIndex-1] : 0;
        video.play();
    }

    function manualPlay() {
        autoMode = false;
        lastRealTime = Date.now();
        video.play();
    }

    function replaySegment() {
        if (currentRatingIndex > 0) {
            currentRatingIndex--;
            playToNextRatingPoint();
        }
    }

    function enableRatings() {
        ratingButtons.forEach(btn => btn.disabled = false);
        updateIntervalDisplay();
    }

    function disableRatings() {
        ratingButtons.forEach(btn => btn.disabled = true);
    }

    function updateIntervalDisplay() {
        const start = currentRatingIndex > 0 ? ratingTimes[currentRatingIndex-1] : 0;
        const end = ratingTimes[currentRatingIndex] || video.duration;
        intervalDisplay.textContent = `${start} - ${end}`;
    }

    // Speed change handlers
    function setSpeed(speed) {
        video.playbackRate = speed;
        lastRealTime = Date.now(); // Reset timing when speed changes
    }

    ratingForm.addEventListener("click", function (e) {
        if (e.target.name === "rating") {
            e.preventDefault();
            ratingTimeInput.value = currentRatingIndex > 0 ? ratingTimes[currentRatingIndex-1] : 0;
            currentRatingIndex++;
            playToNextRatingPoint();
        }
    });

    // Update speed control buttons to use setSpeed()
    document.querySelector('button[onclick*="playbackRate = 1"]').onclick = () => setSpeed(1);
    document.querySelector('button[onclick*="playbackRate = 2"]').onclick = () => setSpeed(2);
    document.querySelector('button[onclick*="playbackRate = 4"]').onclick = () => setSpeed(4);
</script>
</body>
</html>